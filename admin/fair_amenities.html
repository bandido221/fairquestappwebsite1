<!-- File: /admin/fair_amenities.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fair Amenities | FairQuest Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500&family=Domine&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    body {
      background-color: #000;
      font-family: 'Domine', serif;
      color: #f0e6d2;
      padding: 40px;
      text-align: center;
    }
    h1 {
      font-family: 'Cinzel', serif;
      margin-bottom: 16px;
    }
    .box {
      background: #fdf7e1;
      color: #111;
      padding: 20px;
      margin: 16px auto;
      border-radius: 12px;
      max-width: 760px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      text-align: left;
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #bb9457;
      font-size: 16px;
    }
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #bb9457;
      font-size: 16px;
    }
    .btn {
      display: inline-block;
      background-color: #bb9457;
      color: #000;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
      margin: 6px 6px 0 0;
    }
    .btn:hover { background-color: #e6c78c; }
    .btn-primary {
      background: #5b2a86;
      color: #fff;
    }
    .btn-primary:hover { background: #7240a4; }
    .muted { color: #333; opacity: 0.85; font-size: 14px; }
    .error { color: #b73239; font-weight: bold; margin-top: 10px; }
    .ok { color: #1f7a3a; font-weight: bold; margin-top: 10px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 14px;
    }
    th { background: #f3e6c6; }

    .amenities-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .amenity-item {
      background: rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .amenity-item label {
      font-weight: bold;
      cursor: pointer;
    }

    .top-actions {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .access-denied {
      background: rgba(251, 241, 200, 0.96);
      border: 2px solid #aa8452;
      border-radius: 12px;
      color: #3b1f1f;
      max-width: 560px;
      margin: 30px auto;
      padding: 18px;
      text-align: left;
    }
  </style>
</head>

<body>
  <h1>üèïÔ∏è Fair Amenities</h1>

  <div class="box">
    <div class="top-actions">
      <a class="btn" href="/admin/admin_dashboard.html">‚Üê Back to Dashboard</a>
      <button class="btn" id="logoutBtn" type="button">Logout</button>
    </div>
    <div class="muted" style="margin-top:10px;">
      Search a fair by name, select it, review the address + weekends, then choose amenities and save.
    </div>
  </div>

  <div class="box" id="accessBox" style="display:none;">
    <div class="access-denied">
      <h2 style="margin:0 0 8px; font-family:'Cinzel', serif; color:#5b2a86;">Access denied</h2>
      <p style="margin:0;">You must be logged in as an admin to view this page.</p>
    </div>
  </div>

  <div class="box" id="mainBox" style="display:none;">
    <h2 style="margin:0 0 10px;">Search Fair</h2>
    <input type="text" id="fairSearch" placeholder="Type fair name..." />
    <div class="muted" style="margin-top:6px;">Tip: type at least 2 characters.</div>

    <div style="margin-top:12px;">
      <select id="fairDropdown">
        <option value="">-- Select a fair --</option>
      </select>
    </div>

    <div id="statusMsg" class="muted" style="margin-top:10px;"></div>
    <div id="errorMsg" class="error"></div>
    <div id="okMsg" class="ok"></div>
  </div>

  <div class="box" id="fairDetailsBox" style="display:none;">
    <h2 style="margin:0 0 6px;">Selected Fair</h2>
    <div id="fairTitle" style="font-weight:bold; font-size:18px;"></div>
    <div id="fairAddress" class="muted" style="margin-top:4px;"></div>

    <h3 style="margin:16px 0 6px;">Weekends</h3>
    <table>
      <thead>
        <tr>
          <th style="width:120px;">Weekend</th>
          <th>Start</th>
          <th>End</th>
        </tr>
      </thead>
      <tbody id="weekendsBody">
        <tr><td colspan="3" class="muted">Select a fair to view weekends.</td></tr>
      </tbody>
    </table>

    <h3 style="margin:16px 0 6px;">Amenities</h3>
    <div class="muted">Nothing is selected by default. Choose what applies, then click Save.</div>

    <div class="amenities-grid">
      <div class="amenity-item">
        <input type="checkbox" id="amenity_showers" />
        <label for="amenity_showers">Showers</label>
      </div>
      <div class="amenity-item">
        <input type="checkbox" id="amenity_camping" />
        <label for="amenity_camping">Camping</label>
      </div>
      <div class="amenity-item">
        <input type="checkbox" id="amenity_rv" />
        <label for="amenity_rv">RV</label>
      </div>
      <div class="amenity-item">
        <input type="checkbox" id="amenity_water" />
        <label for="amenity_water">Water</label>
      </div>
      <div class="amenity-item">
        <input type="checkbox" id="amenity_electric" />
        <label for="amenity_electric">Electric</label>
      </div>
    </div>

    <div style="margin-top:14px;" class="row">
      <button class="btn btn-primary" id="saveBtn" type="button">Save Amenities</button>
      <button class="btn" id="clearBtn" type="button">Clear Selections</button>
    </div>

    <div id="saveMsg" class="muted" style="margin-top:10px;"></div>
    <div id="saveErr" class="error"></div>
    <div id="saveOk" class="ok"></div>
  </div>

  <script>
    // Supabase client (matches your working pages, but stored globally to avoid redeclare)
    window._supabaseClient = window._supabaseClient || window.supabase.createClient(
      'https://awtbjuiqgtdydsqzimul.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3dGJqdWlxZ3RkeWRzcXppbXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE0OTY4MDgsImV4cCI6MjA1NzA3MjgwOH0.ES0B3O_M0dHaMHMutpkXvThMVMwIUxPqL1cvM1J2kUQ'
    );
    const sb = window._supabaseClient;

    if (!sb || !sb.auth) {
      document.getElementById('accessBox').style.display = 'block';
      document.getElementById('mainBox').style.display = 'none';
      document.getElementById('fairDetailsBox').style.display = 'none';
      document.getElementById('accessBox').innerHTML = `
        <div class="access-denied">
          <h2 style="margin:0 0 8px; font-family:'Cinzel', serif; color:#5b2a86;">Supabase failed to load</h2>
          <p style="margin:0;">The Supabase library did not initialize. Check the console/network for the CDN script load.</p>
        </div>
      `;
      throw new Error('Supabase client not initialized (window.supabase missing).');
    }

    const accessBox = document.getElementById('accessBox');
    const mainBox = document.getElementById('mainBox');
    const fairDetailsBox = document.getElementById('fairDetailsBox');

    const fairSearch = document.getElementById('fairSearch');
    const fairDropdown = document.getElementById('fairDropdown');

    const statusMsg = document.getElementById('statusMsg');
    const errorMsg = document.getElementById('errorMsg');
    const okMsg = document.getElementById('okMsg');

    const fairTitle = document.getElementById('fairTitle');
    const fairAddress = document.getElementById('fairAddress');
    const weekendsBody = document.getElementById('weekendsBody');

    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveMsg = document.getElementById('saveMsg');
    const saveErr = document.getElementById('saveErr');
    const saveOk = document.getElementById('saveOk');

    const logoutBtn = document.getElementById('logoutBtn');

    let currentFair = null;
    let isAdmin = false;

    function setAccessDenied() {
      accessBox.style.display = 'block';
      mainBox.style.display = 'none';
      fairDetailsBox.style.display = 'none';
    }

    function setAccessGranted() {
      accessBox.style.display = 'none';
      mainBox.style.display = 'block';
    }

    function clearMessages() {
      errorMsg.textContent = '';
      okMsg.textContent = '';
      statusMsg.textContent = '';
      saveErr.textContent = '';
      saveOk.textContent = '';
      saveMsg.textContent = '';
    }

    function clearAmenityChecks() {
      document.getElementById('amenity_showers').checked = false;
      document.getElementById('amenity_camping').checked = false;
      document.getElementById('amenity_rv').checked = false;
      document.getElementById('amenity_water').checked = false;
      document.getElementById('amenity_electric').checked = false;
    }

    function buildWeekendsRows(fair) {
      const pairs = [
        { label: 'Week 1',  s: fair.start_date,       e: fair.end_date },
        { label: 'Week 2',  s: fair.week2_start_date, e: fair.week2_end_date },
        { label: 'Week 3',  s: fair.week3_start_date, e: fair.week3_end_date },
        { label: 'Week 4',  s: fair.week4_start_date, e: fair.week4_end_date },
        { label: 'Week 5',  s: fair.week5_start_date, e: fair.week5_end_date },
        { label: 'Week 6',  s: fair.week6_start_date, e: fair.week6_end_date },
        { label: 'Week 7',  s: fair.week7_start_date, e: fair.week7_end_date },
        { label: 'Week 8',  s: fair.week8_start_date, e: fair.week8_end_date },
        { label: 'Week 9',  s: fair.week9_start_date, e: fair.week9_end_date },
        { label: 'Week 10', s: fair.week10_start_date, e: fair.week10_end_date }
      ];

      const rows = pairs
        .filter(p => p.s || p.e)
        .map(p => {
          const s = p.s ? String(p.s) : '';
          const e = p.e ? String(p.e) : '';
          return `<tr><td>${p.label}</td><td>${s}</td><td>${e}</td></tr>`;
        });

      weekendsBody.innerHTML = rows.length
        ? rows.join('')
        : `<tr><td colspan="3" class="muted">No weekend dates found for this fair.</td></tr>`;
    }

    async function checkAdminAccess(session) {
      // Admin = row exists in public.admins where id = auth.uid()
      const uid = session?.user?.id;
      if (!uid) return false;

      const { data, error } = await sb
        .from('admins')
        .select('id')
        .eq('id', uid)
        .maybeSingle();

      if (error) return false;
      return !!data;
    }

    async function initAuthAndAccess() {
      clearMessages();

      const { data, error } = await sb.auth.getSession();
      if (error) {
        setAccessDenied();
        return;
      }

      const session = data?.session;
      if (!session) {
        setAccessDenied();
        return;
      }

      isAdmin = await checkAdminAccess(session);
      if (!isAdmin) {
        setAccessDenied();
        return;
      }

      setAccessGranted();
    }

    let searchTimer = null;

    async function searchFairsByName() {
      clearMessages();
      const q = (fairSearch.value || '').trim();

      fairDropdown.innerHTML = `<option value="">-- Select a fair --</option>`;
      currentFair = null;
      fairDetailsBox.style.display = 'none';
      clearAmenityChecks();

      if (q.length < 2) {
        statusMsg.textContent = 'Type at least 2 characters to search.';
        return;
      }

      statusMsg.textContent = 'Searching...';

      const { data, error } = await sb
        .from('renaissance_fairs')
        .select('id, name')
        .ilike('name', `%${q}%`)
        .order('name', { ascending: true })
        .limit(50);

      if (error) {
        statusMsg.textContent = '';
        errorMsg.textContent = 'Search failed: ' + (error.message || String(error));
        return;
      }

      statusMsg.textContent = (data && data.length) ? `Found ${data.length} result(s).` : 'No results found.';

      if (data && data.length) {
        for (const f of data) {
          const opt = document.createElement('option');
          opt.value = String(f.id);
          opt.textContent = `${f.name}`;
          fairDropdown.appendChild(opt);
        }
      }
    }

    async function loadFairDetails(fairId) {
      clearMessages();
      fairDetailsBox.style.display = 'none';
      clearAmenityChecks();
      saveMsg.textContent = '';
      saveErr.textContent = '';
      saveOk.textContent = '';

      if (!fairId) return;

      statusMsg.textContent = 'Loading fair details...';

      const { data: fair, error } = await sb
        .from('renaissance_fairs')
        .select(`
          id, name, address, city, state, zip,
          start_date, end_date,
          week2_start_date, week2_end_date,
          week3_start_date, week3_end_date,
          week4_start_date, week4_end_date,
          week5_start_date, week5_end_date,
          week6_start_date, week6_end_date,
          week7_start_date, week7_end_date,
          week8_start_date, week8_end_date,
          week9_start_date, week9_end_date,
          week10_start_date, week10_end_date
        `)
        .eq('id', parseInt(fairId))
        .maybeSingle();

      if (error || !fair) {
        statusMsg.textContent = '';
        errorMsg.textContent = 'Failed to load fair: ' + (error?.message || 'Not found');
        return;
      }

      currentFair = fair;

      // Display fair info
      fairTitle.textContent = fair.name || '';
      const zipPart = fair.zip ? ` ${fair.zip}` : '';
      fairAddress.textContent = `${fair.address}, ${fair.city}, ${fair.state}${zipPart}`;

      // Weekends table
      buildWeekendsRows(fair);

      // Load existing amenities (if any)
      statusMsg.textContent = 'Loading existing amenities...';

      const { data: amenityRow, error: aErr } = await sb
        .from('fair_amenities')
        .select('amenities')
        .eq('fair_id', fair.id)
        .maybeSingle();

      if (aErr) {
        // Not fatal: still allow editing
        statusMsg.textContent = '';
        errorMsg.textContent = 'Could not load existing amenities: ' + (aErr.message || String(aErr));
        fairDetailsBox.style.display = 'block';
        return;
      }

      if (amenityRow && amenityRow.amenities && typeof amenityRow.amenities === 'object') {
        const a = amenityRow.amenities;

        document.getElementById('amenity_showers').checked = !!a.showers;
        document.getElementById('amenity_camping').checked = !!a.camping;
        document.getElementById('amenity_rv').checked = !!a.rv;
        document.getElementById('amenity_water').checked = !!a.water;
        document.getElementById('amenity_electric').checked = !!a.electric;
      }

      statusMsg.textContent = '';
      fairDetailsBox.style.display = 'block';
      okMsg.textContent = 'Fair loaded.';
    }

    async function saveAmenities() {
      saveErr.textContent = '';
      saveOk.textContent = '';
      saveMsg.textContent = '';

      if (!currentFair || !currentFair.id) {
        saveErr.textContent = 'Select a fair first.';
        return;
      }

      const amenities = {};
      if (document.getElementById('amenity_showers').checked) amenities.showers = true;
      if (document.getElementById('amenity_camping').checked) amenities.camping = true;
      if (document.getElementById('amenity_rv').checked) amenities.rv = true;
      if (document.getElementById('amenity_water').checked) amenities.water = true;
      if (document.getElementById('amenity_electric').checked) amenities.electric = true;

      // Allow saving empty {} too (meaning "no amenities selected"), in case admin wants to clear.
      saveMsg.textContent = 'Saving...';

      const payload = {
        fair_id: currentFair.id,
        amenities: amenities,
        updated_at: new Date().toISOString()
      };

      const { error } = await sb
        .from('fair_amenities')
        .upsert(payload, { onConflict: 'fair_id' });

      if (error) {
        saveMsg.textContent = '';
        saveErr.textContent = 'Save failed: ' + (error.message || String(error));
        return;
      }

      saveMsg.textContent = '';
      saveOk.textContent = 'Saved successfully.';
    }

    logoutBtn.addEventListener('click', async () => {
      await sb.auth.signOut();
      window.location.href = '/admin/admin_login.html';
    });

    fairSearch.addEventListener('input', () => {
      if (searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(searchFairsByName, 350);
    });

    fairDropdown.addEventListener('change', async () => {
      const id = fairDropdown.value;
      await loadFairDetails(id);
    });

    saveBtn.addEventListener('click', saveAmenities);

    clearBtn.addEventListener('click', () => {
      clearAmenityChecks();
      saveErr.textContent = '';
      saveOk.textContent = '';
      saveMsg.textContent = '';
    });

    // Init
    initAuthAndAccess();
  </script>
</body>
</html>
