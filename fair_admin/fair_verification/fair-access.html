<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FairQuest – Fair Admin Access</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { background:#000; color:#f0e6d2; font-family: 'Domine', serif; margin:0; padding:0; }
  .box { max-width:600px; margin:40px auto; background:#111; padding:20px; border-radius:10px; }
  h1 { text-align:center; font-family:'Cinzel', serif; }
  button, input, textarea, select {
    width:100%; padding:10px; margin-top:10px; border-radius:6px;
    border:1px solid #444; background:#222; color:#f0e6d2;
  }
  button { background:#c79a3b; color:#000; font-weight:bold; cursor:pointer; }
  .hidden { display:none; }
  label { margin-top:15px; display:block; font-weight:bold; }
  .msg { margin-top:15px; padding:10px; border-radius:6px; }
  .error { background:#3b1212; color:#ffb3b3; }
  .success { background:#123b1c; color:#b3ffcf; }
</style>
</head>

<body>

<div class="box">
  <h1>FairQuest – Fair Admin Access</h1>

  <div id="stepChoose">
    <button onclick="showSignup()">No, I need to create an account</button>
    <button onclick="showLogin()">Yes, I already have an account</button>
  </div>

  <div id="stepSignup" class="hidden">
    <h2>Create Your Account</h2>
    <input id="signupEmail" type="email" placeholder="Email">
    <input id="signupPass" type="password" placeholder="Password (8+ chars)">
    <label><input type="checkbox" onclick="togglePass('signupPass')"> Show password</label>
    <button onclick="signup()">Sign Up</button>
    <div id="signupMsg" class="msg hidden"></div>
  </div>

  <div id="stepCheckEmail" class="hidden">
    <h2>Check Your Email</h2>
    <p>Please verify your email, then come back and log in.</p>
    <button onclick="showLogin()">Go to Login</button>
  </div>

  <div id="stepLogin" class="hidden">
    <h2>Login</h2>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginPass" type="password" placeholder="Password">
    <label><input type="checkbox" onclick="togglePass('loginPass')"> Show password</label>
    <button onclick="login()">Login</button>
    <div id="loginMsg" class="msg hidden"></div>
  </div>

  <div id="stepPending" class="hidden">
    <h2>Your Pending Requests</h2>
    <p>
      You already have request(s) waiting for review. If you manage multiple fairs, you can still submit another request for a different fair.
    </p>

    <div id="pendingList" style="margin-top:10px;"></div>

    <button onclick="startNewApplication()">Apply for another fair</button>
    <div id="pendingMsg" class="msg hidden"></div>
  </div>

<div id="stepFairForm" class="hidden">
 <h2>1. Your Fair Information</h2>

  <label for="fairName">Fair name</label>
<input
  type="text"
  id="fairName"
  required
  placeholder="Start typing your fair name…"
  list="fairSuggestions"
  autocomplete="off"
/>
<datalist id="fairSuggestions"></datalist>

<input type="hidden" id="fairId" value="" />

  <label for="fairCity">City</label>
  <input type="text" id="fairCity" required placeholder="City" />

  <label for="fairState">State / Region</label>
  <input type="text" id="fairState" required placeholder="Example: IA" />

  <label for="fairWebsite">Official fair website (if any)</label>
  <input type="url" id="fairWebsite" placeholder="https://yourfair.com" />

  <label for="fairRole">Your role at the fair</label>
  <select id="fairRole" required>
    <option value="">Select one…</option>
    <option value="owner">Owner</option>
    <option value="president">President</option>
    <option value="director">Director / Manager</option>
    <option value="marketing">Marketing / Promotions</option>
    <option value="other">Other</option>
  </select>

  <label for="roleDetails">If “Other”, please explain</label>
  <input type="text" id="roleDetails" placeholder="Example: Vendor coordinator, Board member…" />

  <label for="fairNotes">Anything important we should know about your fair?</label>
  <textarea id="fairNotes" placeholder="Dates, themes, special notes, or anything you’d like us to know when reviewing your request."></textarea>

  <h2>2. Your Contact Information</h2>

  <label for="contactName">Your full name</label>
  <input type="text" id="contactName" required placeholder="Your name" />

  <label for="contactPhone">Phone number (optional)</label>
  <input type="tel" id="contactPhone" placeholder="+1 (555) 555-5555" />
<h2>3. Confirmation Email</h2>

<p style="margin-top:10px;">
  We will email you a copy of this submission to the email address on your FairQuest account:
</p>

<input type="text" id="accountEmailDisplay" readonly placeholder="(your account email will show here)" />

<label style="margin-top:10px;">
  <input type="checkbox" id="useAltEmail" onclick="toggleAltEmail()">
  Also send a copy to a different email
</label>

<div id="altEmailWrap" class="hidden">
  <label for="altEmail">Additional email (optional)</label>
  <input type="email" id="altEmail" placeholder="example@email.com" />
</div>


  <label style="margin-top:15px; font-weight:normal;">
    <input type="checkbox" id="authConfirm">
    I confirm that I am authorized, or I have authorization from the owner, to request admin access and manage this fair’s page on FairQuest.
  </label>

  <button onclick="submitFairInfo()">Submit Fair Verification</button>
  <div id="fairMsg" class="msg hidden"></div>
</div>

</div>

<script>
const supa = window.supabase.createClient(
  'https://awtbjuiqgtdydsqzimul.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3dGJqdWlxZ3RkeWRzcXppbXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE0OTY4MDgsImV4cCI6MjA1NzA3MjgwOH0.ES0B3O_M0dHaMHMutpkXvThMVMwIUxPqL1cvM1J2kUQ',
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storageKey: "fq_fair_admin_access_auth"
    }
  }
);
function togglePass(id){ 
  let x=document.getElementById(id);
  x.type = x.type==="password" ? "text" : "password";
}
function toggleAltEmail(){
  const wrap = document.getElementById("altEmailWrap");
  const cb = document.getElementById("useAltEmail");
  const input = document.getElementById("altEmail");

  if(!wrap || !cb) return;

  if(cb.checked){
    wrap.classList.remove("hidden");
    if(input) input.focus();
  } else {
    wrap.classList.add("hidden");
    if(input) input.value = "";
  }
}
function showMsg(el, text, type){
  el.textContent = text;
  el.className = "msg " + (type === "success" ? "success" : "error");
  el.classList.remove("hidden");
}

function friendlyAuthError(error){
  if(!error) return "Something went wrong. Please try again.";

  const msg = (error.message || "").toLowerCase();

  if(msg.includes("user already registered") || msg.includes("already registered")){
    return "This email already has an account. Click “Yes, I already have an account” and log in.";
  }
  if(msg.includes("invalid login credentials")){
    return "Email or password is incorrect. Please try again.";
  }
  if(msg.includes("email not confirmed") || msg.includes("not confirmed")){
    return "Please check your email and click the verification link before logging in.";
  }
  if(msg.includes("password should be at least") || msg.includes("password")){
    return "Your password must be at least 8 characters. Please make it longer and try again.";
  }
  if(msg.includes("invalid email")){
    return "That email address doesn’t look right. Please check it and try again.";
  }
  if(msg.includes("rate limit") || msg.includes("too many requests")){
    return "Too many attempts. Please wait a minute and try again.";
  }

  return "We couldn’t complete that request. Please double-check your info and try again.";
}

function friendlyDbError(error){
  if(!error) return "Something went wrong. Please try again.";

  const msg = (error.message || "").toLowerCase();

  if(msg.includes("permission denied") || msg.includes("not authorized") || msg.includes("rls")){
    return "We couldn’t submit your request due to a permission issue. Please contact FairQuest support.";
  }
  if(msg.includes("duplicate") || msg.includes("unique constraint")){
    return "It looks like you already submitted a request for this fair. Please wait while we review it.";
  }
  if(msg.includes("network") || msg.includes("failed to fetch")){
    return "Connection problem. Please check your internet and try again.";
  }

  return "We couldn’t submit your request. Please try again in a moment.";
}


function showSignup(){ stepChoose.classList.add('hidden'); stepSignup.classList.remove('hidden'); }
function showLogin(){ stepChoose.classList.add('hidden'); stepLogin.classList.remove('hidden'); }
function showFairForm(){ stepFairForm.classList.remove('hidden'); }
function renderPendingList(rows){
  if(!rows || rows.length === 0){
    pendingList.innerHTML = "<p>No pending requests found.</p>";
    return;
  }

  const items = rows.map(r => {
    const cityState = `${r.fair_city || ""}${r.fair_city && r.fair_state ? ", " : ""}${r.fair_state || ""}`;
    const isPending = (r.approved === false || r.approved === null) && !r.approved_at;

    return `<div style="border:1px solid #333; border-radius:8px; padding:10px; margin-top:10px;">
      <b>${r.fair_name || "Unknown fair"}</b><br/>
      <span>${cityState}</span>
      ${isPending ? `
        <button style="margin-top:10px; background:#7a2e2e; color:#fff;"
          onclick="deletePendingRequest('${r.id}')">
          Delete this request
        </button>
      ` : ``}
    </div>`;
  }).join("");

  pendingList.innerHTML = items;
}


async function loadPendingApplications(userId){
  const { data, error } = await supa
    .from("fair_verification")
    .select("id,fair_name,fair_city,fair_state,approved,approved_at,submitted_at")
    .eq("user_id", userId)
    .eq("approved", false)
    .order("submitted_at", { ascending: false });

  if(error){
    renderPendingList([]);
    return { rows: [], error };
  }

  return { rows: data || [], error: null };
}

function startNewApplication(){
  stepPending.classList.add("hidden");
  stepFairForm.classList.remove("hidden");
}
let fairSuggestionMap = new Map();
async function deletePendingRequest(id){
  const ok = confirm("Delete this pending request? This cannot be undone.");
  if(!ok) return;

  const { data: userData } = await supa.auth.getUser();
  const user = userData.user;

  if(!user){
    showMsg(pendingMsg, "You must be logged in to delete a request.", "error");
    return;
  }

  const { error } = await supa
    .from("fair_verification")
    .delete()
    .eq("id", id)
    .eq("user_id", user.id)
    .eq("approved", false);

  if(error){
    showMsg(pendingMsg, friendlyDbError(error), "error");
    return;
  }

  showMsg(pendingMsg, "Deleted. Your request was removed.", "success");

  const { rows } = await loadPendingApplications(user.id);
  renderPendingList(rows);

  if(rows.length === 0){
    setTimeout(() => startNewApplication(), 800);
  }
}

async function loadFairSuggestions(query){
  const q = (query || "").trim();
  if(q.length < 2){
    fairSuggestions.innerHTML = "";
    fairSuggestionMap = new Map();
    return;
  }

  const { data, error } = await supa
    .from("renaissance_fairs")
    .select("id,name,city,state")
    .ilike("name", `%${q}%`)
    .limit(10);

  if(error || !data){
    fairSuggestions.innerHTML = "";
    fairSuggestionMap = new Map();
    return;
  }

  fairSuggestionMap = new Map();
  fairSuggestions.innerHTML = data.map(f => {
    const label = `${f.name} — ${f.city}, ${f.state}`;
    fairSuggestionMap.set(label, f.id);
    return `<option value="${label}"></option>`;
  }).join("");
}

function clearFairSelection(){
  fairId.value = "";
}

function trySetFairIdFromInput(){
  const label = fairName.value.trim();
  const id = fairSuggestionMap.get(label);
  if(id){
    fairId.value = String(id);
  } else {
    fairId.value = "";
  }
}

fairName.addEventListener("input", async () => {
  clearFairSelection();
  await loadFairSuggestions(fairName.value);
});

fairName.addEventListener("change", () => {
  trySetFairIdFromInput();
});


async function signup(){
  const email = signupEmail.value;
  const pass = signupPass.value;

const { error } = await supa.auth.signUp({ email, password: pass });

    if(error){
    showMsg(signupMsg, friendlyAuthError(error), "error");
    return;
  }


  stepSignup.classList.add('hidden');
  stepCheckEmail.classList.remove('hidden');
}

// LOGIN
async function login(){
  const email = loginEmail.value;
  const pass = loginPass.value;

  const { data, error } = await supa.auth.signInWithPassword({
    email, password:pass
  });

   if(error){
    showMsg(loginMsg, friendlyAuthError(error), "error");
    return;
  }


  stepLogin.classList.add('hidden');

  accountEmailDisplay.value = data?.user?.email || email || "";

  const userId = data?.user?.id;
  if(!userId){
    stepFairForm.classList.remove("hidden");
    return;
  }

  const { rows } = await loadPendingApplications(userId);

  if(rows.length > 0){
    renderPendingList(rows);
    stepPending.classList.remove("hidden");
    stepFairForm.classList.add("hidden");
  } else {
    stepFairForm.classList.remove("hidden");
  }
}

async function submitFairInfo(){
  const updates = {
    fair_name: fairName.value.trim(),
    fair_city: fairCity.value.trim(),
    fair_state: fairState.value.trim(),
    fair_website: fairWebsite.value.trim(),
    fair_role: fairRole.value,
    role_details: roleDetails.value.trim(),
    fair_notes: fairNotes.value.trim(),
    contact_name: contactName.value.trim(),
    contact_phone: contactPhone.value.trim()
  };

  const { data: userData } = await supa.auth.getUser();
  const user = userData.user;

  if(!authConfirm.checked){
    showMsg(
      fairMsg,
      "Please check the authorization box to confirm you are allowed to request admin access for this fair.",
      "error"
    );
    return;
  }


  const { data: existingPending, error: existingErr } = await supa
    .from("fair_verification")
    .select("id")
    .eq("user_id", user.id)
    .eq("approved", false)
    .eq("fair_name", updates.fair_name)
    .eq("fair_city", updates.fair_city)
    .eq("fair_state", updates.fair_state)
    .limit(1);

  if(!existingErr && existingPending && existingPending.length > 0){
    showMsg(
      fairMsg,
      `You already have a pending request for "${updates.fair_name}" in ${updates.fair_city}, ${updates.fair_state}. Please wait for review, or change the fair information to submit a different fair.`,
      "error"
    );
    return;
  }

  const { error } = await supa
    .from('fair_verification')
    .insert([
           {
        user_id: user.id,
        fair_name: updates.fair_name,
        fair_city: updates.fair_city,
        fair_state: updates.fair_state,
        fair_website: updates.fair_website,
        fair_role: updates.fair_role,
        role_details: updates.role_details,
        fair_notes: updates.fair_notes,
        contact_name: updates.contact_name,
        contact_phone: updates.contact_phone,
        extra_email: (useAltEmail.checked ? altEmail.value.trim() : null),
        fair_id: (fairId.value ? parseInt(fairId.value, 10) : null),
        authorization_confirmed: true
      }

    ]);

    if(error){
    showMsg(fairMsg, friendlyDbError(error), "error");
    return;
  }


showSubmitModal();
   setTimeout(() => {
     window.location.href = "https://www.fairquestapp.com/";
   }, 2500);
}
function showSubmitModal(){
  submitModal.classList.remove("hidden");
  submitModal.style.display = "flex";
}

function confirmAndRedirect(){
window.location.href = "https://www.fairquestapp.com/";
}

function addAnotherFairFromModal(){
submitModal.classList.add("hidden");
submitModal.style.display = "none";

  stepChoose.classList.add("hidden");
  stepSignup.classList.add("hidden");
  stepCheckEmail.classList.add("hidden");
  stepLogin.classList.add("hidden");
  stepPending.classList.add("hidden");

  fairName.value = "";
  fairCity.value = "";
  fairState.value = "";
  fairWebsite.value = "";
  fairRole.value = "";
  roleDetails.value = "";
  fairNotes.value = "";
  contactName.value = "";
  contactPhone.value = "";
  authConfirm.checked = false;

  useAltEmail.checked = false;
  altEmail.value = "";
  altEmailWrap.classList.add("hidden");

  fairId.value = "";
  fairSuggestions.innerHTML = "";
  fairSuggestionMap = new Map();

  fairMsg.classList.add("hidden");

  stepFairForm.classList.remove("hidden");
}

document.addEventListener("DOMContentLoaded", async () => {
  const { data } = await supa.auth.getSession();
  const session = data?.session;

  if(session?.user){
    stepChoose.classList.add("hidden");
    stepSignup.classList.add("hidden");
    stepCheckEmail.classList.add("hidden");
    stepLogin.classList.add("hidden");

    accountEmailDisplay.value = session.user.email || "";

    const { rows } = await loadPendingApplications(session.user.id);
    if(rows.length > 0){
      renderPendingList(rows);
      stepPending.classList.remove("hidden");
      stepFairForm.classList.add("hidden");
    } else {
      stepPending.classList.add("hidden");
      stepFairForm.classList.remove("hidden");
    }
  }
});
</script>
<div id="submitModal" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.8);
  align-items:center; justify-content:center; z-index:9999;">
  <div style="
    max-width:520px; background:#111; border:1px solid #444;
    padding:20px; border-radius:10px; text-align:center;">
  <h2>Request Submitted</h2>
<p style="margin-top:10px;">
  We received your request. We will contact the fair’s official page and/or website
  to verify authorization.
</p>
<p style="margin-top:10px;">
  Once your request is approved, you will receive an email confirmation.
</p>
<p style="margin-top:10px;">
  You can also check your profile. When approved, a new <b>Manage Fair</b> button
  will appear, allowing you to access and manage your fair’s page.
</p>
    <button style="margin-top:15px;" onclick="confirmAndRedirect()">OK</button>
<button style="margin-top:10px;" onclick="addAnotherFairFromModal()">Add Another Fair</button>
  </div>
</div>

</body>
</html>
