<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="/css/style.css" />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HP222J86X0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-HP222J86X0');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fair Details | FairQuest</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500&family=Domine&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      background-color: #000;
      font-family: 'Domine', serif;
      color: #f8eaea; 
      padding: 40px;
      text-align: center;
    }
    h1, h2 {
      font-family: 'Cinzel', serif;
    }
    .top-banner, .logo {
      display: block;
      margin: 0 auto 20px;
    }
    .top-banner {
      max-width: 600px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .logo {
      max-width: 100px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    }
    .card {
      background: #a0955e;
      color: #222;
      border-radius: 12px;
      padding: 20px;
      max-width: 700px;
      margin: 20px auto;
      text-align: left;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    .card, .card * {
  color: #000 !important;
}
    /* NEW: centered message when there is no image */
.no-image-msg {
  font-weight: 600;
  font-size: 1rem;
  text-align: center;
  padding: 8px 0;
}

  .card h2, .card h3 {
  color: #000 !important;
}
/* Ensure the website link renders black too */
#fairWebsite a {
  color: #000 !important;
}

    .card p {
      margin: 8px 0;
    }
    .update-btn {
      margin-top: 20px;
      background-color: #bb9457;
      color: black;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .update-btn:hover {
      background-color: #d8c6a5;
    }
    .link {
      color: #2a2a2a;
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <img src="/images/banner.png" alt="FairQuest Banner" class="top-banner" />
  <img src="/images/logo.png" alt="FairQuest Logo" class="logo" />
  
    <h1>Fair Details</h1>

  <!-- Content section for AdSense "publisher-content" signal -->
  <section style="max-width:760px;margin:18px auto 12px;padding:0 18px;text-align:left;">
    <p>
      This page shows dates, location, website, and weekend schedule for the selected fair. 
      We keep entries current as organizers publish updates, and we correct records when new details come in. 
      If a detail is missing, it will appear here once it‚Äôs confirmed by us.
    </p>
  </section>

  <div class="card" id="fairCard">

    <p><strong></strong><br><img id="fairImage" src="" style="width:100%; max-width:600px; border-radius:10px; margin-top:10px;" /></p>
<h2 id="fairName">Loading...</h2>
<p id="descriptionRow" style="display:none;">
  <strong>üìú Description:</strong> <span id="fairDescription"></span>
</p>
<p><strong>üìç Address:</strong> <span id="fairAddress"></span></p>

    <p><strong>üèôÔ∏è City:</strong> <span id="fairCity"></span></p>
    <p><strong>üó∫Ô∏è State:</strong> <span id="fairState"></span></p>
<p><strong>üåê Website:</strong> <span id="fairWebsite"></span></p>
<p><strong>üïí Hours:</strong> <span id="fairHours"></span></p>
<p><strong>üìÖ Weekends:</strong></p>
<ul id="weekendsList"></ul>


    <button class="update-btn" onclick="goToUpdatePage()">üõ†Ô∏è Update This Fair</button>

<button class="update-btn" id="applyBtn" style="display:none; margin-left:10px;">
  üìÑ Apply To This Fair
</button>

<div class="hint" id="applyHint" style="display:none; margin-top:10px;">
  To apply, you must be logged in and have an approved Vendor/Performer profile.
</div>
  </div>

  <div class="card" id="vendorsCard" style="display:none">
    <h3>üß∫  Vendors</h3>
    <ul id="vendorList"></ul>
  </div>

  <div class="card" id="performersCard" style="display:none">
    <h3>üé≠  Performers</h3>
    <ul id="performerList"></ul>
  </div>

  <script>
    const supabaseClient = window.supabase.createClient(
      'https://awtbjuiqgtdydsqzimul.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3dGJqdWlxZ3RkeWRzcXppbXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE0OTY4MDgsImV4cCI6MjA1NzA3MjgwOH0.ES0B3O_M0dHaMHMutpkXvThMVMwIUxPqL1cvM1J2kUQ'
    );

    const urlParams = new URLSearchParams(window.location.search);
    const fairId = urlParams.get('id');

    async function loadFair() {
      const { data, error } = await supabaseClient
        .from('renaissance_fairs')
        .select('*')
        .eq('id', fairId)
        .single();

      if (error || !data) {
        document.getElementById('fairCard').innerHTML = '<p>‚ùå Failed to load fair information.</p>';
        return;
      }

document.getElementById('fairName').textContent = data.name;

if (data.description && data.description.trim() !== '') {
  document.getElementById('descriptionRow').style.display = 'block';
  document.getElementById('fairDescription').textContent = data.description;
} else {
  document.getElementById('descriptionRow').style.display = 'none';
}


document.getElementById('fairAddress').textContent = data.address;
document.getElementById('fairCity').textContent = data.city;
document.getElementById('fairState').textContent = data.state;

document.getElementById('fairWebsite').innerHTML = data.website
  ? `<a href="${data.website}" target="_blank">${data.website}</a>`
  : 'N/A';

let hoursValue = (data.hours ?? '').trim();
document.getElementById('fairHours').textContent =
  hoursValue !== '' ? hoursValue : 'Look on the website';


{
  const imgUrl = (data.image_url || '').trim();
  const imgEl = document.getElementById('fairImage');
  const imgWrap = imgEl.parentElement; // <p> that contains the image

  if (imgUrl) {
    imgEl.src = imgUrl;
    imgEl.alt = data.name || 'Fair image';
    imgEl.style.display = 'block';
    const oldMsg = imgWrap.querySelector('.no-image-msg');
    if (oldMsg) oldMsg.remove();
  } else {
    imgEl.style.display = 'none';
    if (!imgWrap.querySelector('.no-image-msg')) {
      const msg = document.createElement('div');
      msg.className = 'no-image-msg';
      msg.textContent = 'Waiting for fair to add image';
      imgWrap.appendChild(msg);
    }
  }
}

    function formatDate(d) {
  const date = new Date(d);
  const dd = String(date.getDate()).padStart(2, '0');
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const yy = String(date.getFullYear()).slice(-2);
  return `${dd}-${mm}-${yy}`;
}

const weekendFields = [
  ['start_date', 'end_date'],
  ...Array.from({length: 9}, (_, i) => [`week${i+2}_start_date`, `week${i+2}_end_date`])
];

const weekendsList = document.getElementById('weekendsList');
weekendsList.innerHTML = '';

weekendFields.forEach(([startKey, endKey]) => {
  if (data[startKey] && data[endKey]) {
    const li = document.createElement('li');
    li.textContent = `${formatDate(data[startKey])} ‚Üí ${formatDate(data[endKey])}`;
    weekendsList.appendChild(li);
  }
});

    }

    async function loadShowcase() {
      const { data: applications, error } = await supabaseClient
        .from('vendor_performer_applications')
        .select('id, name, application_type, approval_status, vendor_type')
        .eq('approval_status', 'approved');

      if (error) return;

      const { data: fairLinks, err2 } = await supabase
        .from('vendor_application_fairs')
        .select('application_id, fair_id')
        .eq('fair_id', fairId);

      if (err2) return;

      const approvedIds = fairLinks.map(link => link.application_id);
      const vendors = applications.filter(a => a.application_type === false && approvedIds.includes(a.id));
      const performers = applications.filter(a => a.application_type === true && approvedIds.includes(a.id));

      const vlist = document.getElementById('vendorList');
      const plist = document.getElementById('performerList');

      vendors.forEach(v => {
        const li = document.createElement('li');
        li.innerHTML = `<a class="link" href="/fairs/vendor_performer_detail.html?id=${v.id}&type=vendor">${v.name}</a> ‚Äî ${v.vendor_type || ''}`;
        vlist.appendChild(li);
      });

      performers.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `<a class="link" href="/fairs/vendor_performer_detail.html?id=${p.id}&type=performer">${p.name}</a>`;
        plist.appendChild(li);
      });

      if (vendors.length) document.getElementById('vendorsCard').style.display = 'block';
      if (performers.length) document.getElementById('performersCard').style.display = 'block';
    }

    function goToUpdatePage() {
      window.location.href = `update_fair.html?id=${fairId}`;
    }

  async function setupApplyButton(fairRow) {
  const applyBtn = document.getElementById('applyBtn');
  const applyHint = document.getElementById('applyHint');

  // default hidden
  applyBtn.style.display = 'none';
  applyHint.style.display = 'none';

  // only Gold fairs show apply entry point
  if ((fairRow.fair_tier || '').toLowerCase() !== 'gold') return;

  // must be logged in
  const { data: { user }, error: userErr } = await supabaseClient.auth.getUser();
  if (userErr || !user) {
    applyHint.style.display = 'block';
    return;
  }

  // must have at least 1 approved VPA identity
  const { data: vpaRows, error: vpaErr } = await supabaseClient
    .from('vendor_performer_applications')
    .select('id')
    .eq('user_id', user.id)
    .eq('approval_status', 'approved')
    .limit(1);

  if (vpaErr || !vpaRows || vpaRows.length === 0) {
    applyHint.style.display = 'block';
    return;
  }

  // show button
  applyBtn.style.display = 'inline-block';
applyBtn.onclick = () => {
  // apply page will handle 1 identity vs dropdown for multiple identities
  window.location.href = `/fair_admin/fair_info/fair_apply.html?fair_id=${fairRow.id}`;
};

}

const _origLoadFair = loadFair;
loadFair = async function() {
  const { data, error } = await supabaseClient
    .from('renaissance_fairs')
    .select('*')
    .eq('id', fairId)
    .single();

  if (error || !data) {
    document.getElementById('fairCard').innerHTML = '<p>‚ùå Failed to load fair information.</p>';
    return;
  }

  document.getElementById('fairName').textContent = data.name;

  if (data.description && data.description.trim() !== '') {
    document.getElementById('descriptionRow').style.display = 'block';
    document.getElementById('fairDescription').textContent = data.description;
  } else {
    document.getElementById('descriptionRow').style.display = 'none';
  }

  document.getElementById('fairAddress').textContent = data.address;
  document.getElementById('fairCity').textContent = data.city;
  document.getElementById('fairState').textContent = data.state;

  document.getElementById('fairWebsite').innerHTML = data.website
    ? `<a href="${data.website}" target="_blank">${data.website}</a>`
    : 'N/A';

  let hoursValue = (data.hours ?? '').trim();
  document.getElementById('fairHours').textContent =
    hoursValue !== '' ? hoursValue : 'Look on the website';

  {
    const imgUrl = (data.image_url || '').trim();
    const imgEl = document.getElementById('fairImage');
    const imgWrap = imgEl.parentElement;

    if (imgUrl) {
      imgEl.src = imgUrl;
      imgEl.alt = data.name || 'Fair image';
      imgEl.style.display = 'block';
      const oldMsg = imgWrap.querySelector('.no-image-msg');
      if (oldMsg) oldMsg.remove();
    } else {
      imgEl.style.display = 'none';
      if (!imgWrap.querySelector('.no-image-msg')) {
        const msg = document.createElement('div');
        msg.className = 'no-image-msg';
        msg.textContent = 'Waiting for fair to add image';
        imgWrap.appendChild(msg);
      }
    }
  }

  function formatDate(d) {
    const date = new Date(d);
    const dd = String(date.getDate()).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const yy = String(date.getFullYear()).slice(-2);
    return `${dd}-${mm}-${yy}`;
  }

  const weekendFields = [
    ['start_date', 'end_date'],
    ...Array.from({length: 9}, (_, i) => [`week${i+2}_start_date`, `week${i+2}_end_date`])
  ];

  const weekendsList = document.getElementById('weekendsList');
  weekendsList.innerHTML = '';

  weekendFields.forEach(([startKey, endKey]) => {
    if (data[startKey] && data[endKey]) {
      const li = document.createElement('li');
      li.textContent = `${formatDate(data[startKey])} ‚Üí ${formatDate(data[endKey])}`;
      weekendsList.appendChild(li);
    }
  });

  // NEW: gate Apply button
  await setupApplyButton(data);
};

loadFair();
loadShowcase();

  </script>
</body>
</html>