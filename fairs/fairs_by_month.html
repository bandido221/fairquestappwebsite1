<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="/css/style.css" />

  <!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HP222J86X0"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fairs by Month | FairQuest</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500&family=Domine&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      background-color: #000;
      font-family: 'Domine', serif;
      color: #f0e6d2;
      padding: 40px;
      text-align: center;
    }
    h1 {
      font-family: 'Cinzel', serif;
      font-size: 2.5rem;
      margin-bottom: 20px;
    }
    .card {
  background: #89805a;
  color: #222;
  border-radius: 12px;
  padding: 20px;
  max-width: 700px;
  margin: 20px auto;
  text-align: left;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}


.card * {
  color: #222 !important;
}




 /* NEW: centered message when there is no image */
.no-image-msg {
  font-weight: 600;
  font-size: 1rem;
  text-align: center;
  padding: 0 8px;
}



.top-banner {
      width: 100%;
      max-width: 600px;
      display: block;
      margin: 0 auto 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .fair-link {
  display: inline-block;
  background-color: #bb9457;
  color: black;
  font-weight: bold;
  padding: 8px 14px;
  border-radius: 8px;
  text-decoration: none;
  font-size: 1.2rem;
  transition: background-color 0.2s ease;
  margin-bottom: 10px;
}
.fair-link:hover {
  background-color: #f2e1c1;
  color: #000;
}

   
    .logo {
      width: 120px;
      display: block;
      margin: 0 auto 20px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
    }
    .card-content {
      padding: 16px;
    }
    .badge {
      display: inline-block;
      background-color: #bb9457;
      color: black;
      font-weight: bold;
      border-radius: 6px;
      padding: 4px 10px;
      margin: 2px 4px;
    }
  </style>
</head>
<body>

   <!-- Banner Image -->
   <img src="/images/banner.png" alt="FairQuest Banner" class="top-banner" />

   <header>
     <img src="/images/logo.png" alt="FairQuest Logo" class="logo" />
     <h1>Welcome to FairQuest</h1>

  <h1>üé≠ Fairs in <span id="monthName"></span></h1>

  <!-- Content section for AdSense "publisher-content" signal -->
  <section style="max-width:760px;margin:18px auto 12px;padding:0 18px;text-align:left;">
    <p>
      This page shows all Renaissance fairs taking place in the selected month. 
      Use the dropdown to filter by state or scroll through to explore what‚Äôs available. 
      Each fair listing includes dates, locations, and official links when possible. 
      The information is kept current as new events are added or updated by us.
    </p>
  </section>

  <div style="margin-bottom: 20px;">

    <label for="stateFilter" style="font-weight:bold;">Filter by State:</label>
    <select id="stateFilter" onchange="applyStateFilter()" style="margin-left: 10px; padding: 8px; border-radius: 6px;">
      <option value="">All States</option>
    </select>
  </div>
  
  <div id="fairResults">Loading...</div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient('https://awtbjuiqgtdydsqzimul.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3dGJqdWlxZ3RkeWRzcXppbXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE0OTY4MDgsImV4cCI6MjA1NzA3MjgwOH0.ES0B3O_M0dHaMHMutpkXvThMVMwIUxPqL1cvM1J2kUQ'
    );

let allFairsThisMonth = [];
let currentStateFilter = "";

    const month = parseInt(new URLSearchParams(window.location.search).get('month'));
    const monthName = new Date(0, month - 1).toLocaleString('default', { month: 'long' });
    document.getElementById('monthName').textContent = monthName || 'Unknown';

    async function fetchFairsByMonth() {
  const { data, error } = await supabaseClient.from('renaissance_fairs').select('*');
  if (error) {
    document.getElementById('fairResults').innerHTML = `<p>Error: ${error.message}</p>`;
    return;
  }

  allFairsThisMonth = data.filter(fair => {
    const datesToCheck = [];

    if (fair.start_date) datesToCheck.push(fair.start_date);
    for (let i = 2; i <= 10; i++) {
      const start = fair[`week${i}_start_date`];
      if (start) datesToCheck.push(start);
    }

    return datesToCheck.some(date => new Date(date).getMonth() + 1 === month);
  });

  buildStateDropdown();
  displayFairs(allFairsThisMonth);
}

function buildStateDropdown() {
  const dropdown = document.getElementById('stateFilter');
  const uniqueStates = [...new Set(allFairsThisMonth.map(fair => fair.state))].sort();

  uniqueStates.forEach(state => {
    const option = document.createElement('option');
    option.value = state;
    option.textContent = state;
    dropdown.appendChild(option);
  });
}


function displayFairs(fairs) {
  const container = document.getElementById('fairResults');
  container.innerHTML = '';

  const filtered = fairs.filter(fair => {
    if (!currentStateFilter) return true;
    return fair.state === currentStateFilter;
  });

  if (!filtered.length) {
    container.innerHTML = '<p>No fairs found for this selection.</p>';
    return;
  }

  filtered.forEach(fair => {
    const weekends = [];

    if (fair.start_date && fair.end_date) {
      weekends.push(`${fair.start_date} to ${fair.end_date}`);
    }

    for (let i = 2; i <= 10; i++) {
      const start = fair[`week${i}_start_date`];
      const end = fair[`week${i}_end_date`];
      if (start && end) {
        weekends.push(`${start} to ${end}`);
      }
    }

// NEW: build image block with message when missing
const imgUrl = (fair.image_url || '').trim();
const imageHtml = imgUrl
  ? `<img src="${imgUrl}" alt="${fair.name}" />`
  : `<div class="no-image-msg">Waiting for fair to add image</div>`;

container.innerHTML += `
  <div class="card">
    <div class="card-image">
      ${imageHtml}
    </div>
    <div class="card-content">
      <a href="fair_detail.html?id=${fair.id}" class="fair-link">${fair.name}</a>
      <p><span class="badge">${fair.state}</span></p>
      <p><strong>üìç Location:</strong> ${fair.address}, ${fair.city}, ${fair.zip || ''}</p>
      ${fair.website ? `<p><strong>üåê Website:</strong> <a href="${fair.website}" target="_blank">${fair.website}</a></p>` : ''}
      ${weekends.length > 0 ? `
        <p><strong>üìÖ Weekends:</strong></p>
        ${weekends.map(date => `<p>${date}</p>`).join('')}
      ` : '<p><strong>üìÖ Weekends:</strong> None listed</p>'}
    </div>
  </div>
`;

  });
}

function applyStateFilter() {
  const dropdown = document.getElementById('stateFilter');
  currentStateFilter = dropdown.value;
  displayFairs(allFairsThisMonth);
}

    

    fetchFairsByMonth();
  </script>
</body>
</html>
