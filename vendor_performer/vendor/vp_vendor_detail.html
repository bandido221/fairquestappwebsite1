<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="/css/style.css" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vendor Online Page Setup | FairQuest</title>

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500&family=Domine&display=swap" rel="stylesheet">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HP222J86X0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HP222J86X0');
  </script>

  <style>
    body {
      font-family: 'Domine', serif;
      background:#000;
      padding:40px;
      text-align:center;
      color:#f0e6d2;
      margin:0;
    }
    h1, h2 { font-family:'Cinzel', serif; }
    .top-banner {
      width:100%;
      max-width:600px;
      height:auto;
      object-fit:contain;
      display:block;
      margin:0 auto 20px auto;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    .logo {
      max-width:100px;
      height:auto;
      margin:0 auto 20px auto;
      display:block;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    }
    .container{
      max-width:800px;
      margin:auto;
      background:rgba(251,241,200,0.88);
      padding:30px 40px;
      border-radius:12px;
      border:2px solid #aa8425;
      box-shadow:0 4px 15px rgba(0,0,0,0.4);
      color:#3b1f1f;
      text-align:left;
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .field { flex:1; min-width:240px; }
    label { display:block; font-weight:bold; margin:12px 0 6px; }
    input, textarea {
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:8px;
      border:1px solid #c9b27a;
      font-family:'Domine', serif;
      font-size:16px;
    }
    textarea { min-height:90px; resize:vertical; }
    .actions {
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:20px;
    }
    button{
      padding:12px 20px;
      font-size:16px;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    .btn-back{ background:#444; color:#fff; }
    .btn-save{ background:#f39c12; color:#fff; }
    .btn-next{ background:#27ae60; color:#fff; }
    .pill {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      background:rgba(0,0,0,0.08);
      margin-bottom:12px;
    }
    .error { color:#7f1d1d; font-weight:bold; margin-top:10px; }
    .ok { color:#14532d; font-weight:bold; margin-top:10px; }
    @media (max-width:768px){
      body{ padding:20px; }
      .container{ padding:20px; }
      button{ width:100%; }
      .actions{ flex-direction:column; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<img src="../../images/banner.png" alt="FairQuest Banner" class="top-banner" />
<img src="../../images/logo.png" alt="FairQuest Logo" class="logo" />

<div class="container">
  <div class="pill">Wizard • Step 1 of 6 • Basics</div>
  <h1>Vendor Online Page Setup</h1>

  <div id="statusMsg" class="loading">Loading…</div>

  <div id="formWrap" style="display:none;">
<div class="row">
  <div class="field">
    <label>Display Name</label>
    <input id="app_display_name" type="text" disabled />

    <!-- ADDRESS DISPLAY -->
    <div id="wizardAddress" style="margin-top:6px; font-size:14px; opacity:.9;"></div>

    <!-- ADDRESS INPUT (shows only if missing) -->
    <div id="addressFields" style="display:none; margin-top:10px;">
      <label for="street_address">Street Address</label>
      <input id="street_address" type="text" placeholder="123 Main St" />

      <div class="row" style="margin-top:8px;">
        <div class="field">
          <label for="city">City</label>
          <input id="city" type="text" placeholder="Des Moines" />
        </div>

        <div class="field">
          <label for="state">State</label>
          <select id="state">
            <option value="">Select…</option>
            <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option>
            <option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option>
            <option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
            <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option>
            <option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option>
            <option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
            <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option>
            <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option>
            <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option>
            <option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option>
            <option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
          </select>
        </div>

        <div class="field">
          <label for="zip_code">Zip Code</label>
          <input id="zip_code" type="text" placeholder="12345" />
        </div>
      </div>
    </div>
<button
  id="saveAddressBtn"
  type="button"
  onclick="saveAddressOnly()"
  style="display:none; margin-top:10px; background:#27ae60; color:#fff; padding:10px 14px; border-radius:6px; border:none; cursor:pointer;">
  Save Address
</button>
    <!-- CHECKBOX -->
    <label style="margin-top:12px;">
      <input id="show_full_address" type="checkbox" style="width:auto; margin-right:8px;" />
      Show full address on my public page
    </label>

    <div id="addressInfo" style="margin-top:6px;"></div>

  </div>

  <div class="field">
    <label for="tagline">Tagline</label>
    <input id="tagline" type="text" placeholder="Short sentence about what you do" />
  </div>
</div>

<div class="row">
  <div class="field">
    <label for="pricing_note">Pricing Note (optional)</label>
    <input id="pricing_note" type="text" placeholder="Example: Items $10–$200, custom quotes available" />
  </div>
</div>





    <div class="actions">
      <button class="btn-back" onclick="goBack()">← Back to Dashboard</button>
      <button class="btn-save" onclick="saveStep()">Save</button>
      <button class="btn-next" onclick="nextStep()">Next →</button>
    </div>

    <div id="saveMsg"></div>
  </div>
</div>

<script>
  /* ---------- SUPABASE CLIENT ---------- */
  window.supabaseClient = window.supabaseClient || window.supabase.createClient(
    'https://awtbjuiqgtdydsqzimul.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3dGJqdWlxZ3RkeWRzcXppbXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE0OTY4MDgsImV4cCI6MjA1NzA3MjgwOH0.ES0B3O_M0dHaMHMutpkXvThMVMwIUxPqL1cvM1J2kUQ'
  );
  const sb = window.supabaseClient;

  const params = new URLSearchParams(window.location.search);
  const vpaId = params.get('vpa_id');

  let vpRow = null;
let vpaRow = null;

  function goBack(){
    window.location.href = '/vendor_performer/vendor/dashboard.html';
  }

  function nextStep(){
    // placeholder for now - we will create step 2 next
    alert('Next step not built yet. Step 2 coming next.');
  }

  async function ensureLoggedIn(){
    const { data:{ session } } = await sb.auth.getSession();
    if(session?.user?.id) return session;

    return new Promise((resolve) => {
      sb.auth.onAuthStateChange((_, s) => resolve(s));
    });
  }

  async function loadOrCreateVpWeb(){
    if(!vpaId){
      document.getElementById('statusMsg').innerHTML = '<p class="error">Missing vpa_id in URL.</p>';
      return;
    }

    const session = await ensureLoggedIn();
    if(!session?.user?.id){
      document.getElementById('statusMsg').innerHTML = '<p class="error">Please sign in to continue.</p>';
      return;
    }
// Load application (for display name + address)
const { data: appRow, error: appErr } = await sb
  .from('vendor_performer_applications')
  .select('id,name,street_address,city,state,zip_code')
  .eq('id', vpaId)
  .single();

if(appErr || !appRow){
  document.getElementById('statusMsg').innerHTML = `<p class="error">Failed to load application.</p>`;
  return;
}
vpaRow = appRow;
document.getElementById('app_display_name').value = vpaRow.name || '';
    // Try load vp_web
    const { data: existing, error: selErr } = await sb
      .from('vp_web')
      .select('*')
      .eq('vpa_id', vpaId)
      .maybeSingle();

    if(selErr){
      document.getElementById('statusMsg').innerHTML = `<p class="error">Failed to load vp_web: ${selErr.message}</p>`;
      return;
    }

    if(existing){
      vpRow = existing;
    } else {
      // Create draft row (RLS requires approved + owner)
      const { data: created, error: insErr } = await sb
        .from('vp_web')
        .insert([{ vpa_id: Number(vpaId), editor_mode: 'wizard', is_published: false, is_active: true }])
        .select('*')
        .single();

      if(insErr){
        document.getElementById('statusMsg').innerHTML =
          `<p class="error">Could not create vp_web row. Make sure your application is approved.</p>`;
        return;
      }
      vpRow = created;
    }

    // Fill form
document.getElementById('tagline').value = vpRow.tagline || '';
document.getElementById('pricing_note').value = vpRow.pricing_note || '';

document.getElementById('show_full_address').checked = !!vpRow.show_full_address;
wireAddressUI();
    document.getElementById('statusMsg').style.display = 'none';
    document.getElementById('formWrap').style.display = 'block';
  }

  async function saveStep(){
    if(!vpRow?.id){
      document.getElementById('saveMsg').innerHTML = '<p class="error">Cannot save: missing vp_web row.</p>';
      return;
    }

const showAddr = document.getElementById('show_full_address').checked;

const payload = {
  editor_mode: 'wizard',
  show_full_address: showAddr,
  tagline: document.getElementById('tagline').value.trim() || null,
  pricing_note: document.getElementById('pricing_note').value.trim() || null
};

// If user wants to show address AND application address is null -> save address into application table
if(showAddr && isAddressNull(vpaRow)){
  const street = document.getElementById('street_address').value.trim();
  const city = document.getElementById('city').value.trim();
  const state = document.getElementById('state').value;
  const zip = document.getElementById('zip_code').value.trim();

  if(!street || !city || !state || !zip){
    document.getElementById('saveMsg').innerHTML = `<p class="error">Please fill Street, City, State, and Zip.</p>`;
    return;
  }

  const { data: updatedApp, error: appUpErr } = await sb
    .from('vendor_performer_applications')
    .update({
      street_address: street,
      city: city,
      state: state,
      zip_code: zip
    })
    .eq('id', Number(vpaId))
    .select('id,name,street_address,city,state,zip_code')
    .single();

  if(appUpErr){
    document.getElementById('saveMsg').innerHTML = `<p class="error">Address save failed: ${appUpErr.message}</p>`;
    return;
  }

  vpaRow = updatedApp;
}

    const { data, error } = await sb
      .from('vp_web')
      .update(payload)
      .eq('id', vpRow.id)
      .select('*')
      .single();

    if(error){
      document.getElementById('saveMsg').innerHTML = `<p class="error">Save failed: ${error.message}</p>`;
      return;
    }

    vpRow = data;
    document.getElementById('saveMsg').innerHTML = '<p class="ok">Saved.</p>';
  }
  async function saveAddressOnly(){
  const street = document.getElementById('street_address').value.trim();
  const city = document.getElementById('city').value.trim();
  const state = document.getElementById('state').value;
  const zip = document.getElementById('zip_code').value.trim();

  if(!street || !city || !state || !zip){
    alert('Please fill Street, City, State, and Zip.');
    return;
  }

  const { error } = await sb
    .from('vendor_performer_applications')
    .update({
      street_address: street,
      city: city,
      state: state,
      zip_code: zip
    })
    .eq('id', Number(vpaId));

  if(error){
    alert('Address save failed: ' + error.message);
    return;
  }

  location.reload();
}
function isAddressNull(a){
  const s = (a?.street_address || '').trim();
  const c = (a?.city || '').trim();
  const st = (a?.state || '').trim();
  const z = (a?.zip_code || '').trim();
  return !s && !c && !st && !z;
}

function formatAddress(a){
  const parts = [];
  if(a?.street_address) parts.push(a.street_address);
  const line2 = [a?.city, a?.state, a?.zip_code].filter(Boolean).join(', ').replace(', ,', ',');
  if(line2.trim()) parts.push(line2);
  return parts.join('<br>');
}

function wireAddressUI(){
  const cb = document.getElementById('show_full_address');
  const info = document.getElementById('addressInfo');
  const fields = document.getElementById('addressFields');
  const wizardAddr = document.getElementById('wizardAddress');
  const saveBtn = document.getElementById('saveAddressBtn');

  const addrMissing = isAddressNull(vpaRow);

  // ALWAYS show address in wizard
  if(addrMissing){
    wizardAddr.innerHTML =
      `<span style="color:#7f1d1d;">Address not set.</span>`;
    saveBtn.style.display = 'inline-block';
  } else {
    wizardAddr.innerHTML =
      `<strong>${formatAddress(vpaRow)}</strong>`;
    saveBtn.style.display = 'none';
  }
  
  function refresh(){
    const checked = cb.checked;

    if(addrMissing){
      info.innerHTML =
        `<span style="opacity:.85;">Address required for public display. Please enter below.</span>`;
      fields.style.display = 'block';
      return;
    }

    if(!checked){
      info.innerHTML =
        `<span style="opacity:.85;">Address hidden on public page.</span>`;
      fields.style.display = 'none';
      return;
    }

    info.innerHTML =
      `<span style="opacity:.85;">Address will be shown on public page.</span>`;
    fields.style.display = 'none';
  }

  cb.addEventListener('change', refresh);
  refresh();
}
  window.addEventListener('DOMContentLoaded', loadOrCreateVpWeb);
</script>

</body>
</html>